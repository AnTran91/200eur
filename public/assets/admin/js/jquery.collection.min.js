!function(e){e.fn.collection=function(t){var n={container:"body",allow_up:!0,up:'<a class="btn btn-icon btn-primary" href="#"><span class="fas fa-arrow-up"></span></a>',before_up:function(e,t){return!0},after_up:function(e,t){return!0},allow_down:!0,down:'<a class="btn btn-icon btn-primary" href="#"><span class="fas fa-arrow-down"></span></a>',before_down:function(e,t){return!0},after_down:function(e,t){return!0},allow_add:!0,add:'<a class="btn btn-icon btn-success float-right" href="#"><span class="fas fa-plus"></span></a>',before_add:function(e,t){return!0},after_add:function(e,t){return!0},allow_remove:!0,remove:'<a class="btn btn-icon btn-danger" href="#"><span class="fas fa-trash"></span></a>',before_remove:function(e,t){return!0},after_remove:function(e,t){return!0},allow_duplicate:!1,duplicate:'<a class="btn btn-icon btn-purple" href="#"><span class="fas fa-th-large"></span></a>',before_duplicate:function(e,t){return!0},after_duplicate:function(e,t){return!0},before_init:function(e){},after_init:function(e){},min:0,max:100,add_at_the_end:!1,prefix:"collection",prototype_name:"__name__",name_prefix:null,elements_selector:"> div, > fieldset",elements_parent_selector:"%id%",children:null,init_with_n_elements:0,hide_useless_buttons:!0,delete_msg:"Are you sure you want to delete this element ?",delete_title:"Confirm",drag_drop:!0,drag_drop_options:{placeholder:"ui-state-highlight"},drag_drop_start:function(e,t){return!0},drag_drop_update:function(e,t){return!0},custom_add_location:!1,action_container_tag:"div",fade_in:!0,fade_out:!0,position_field_selector:null,preserve_names:!1},a=function(t,n){if(!n.attr("id")){var a;do{a=t+"_"+(""+1e3*Math.random()*(new Date).getTime()).replace(".","").split("").sort(function(){return.5-Math.random()}).join("")}while(e("#"+a).length>0);n.attr("id",a)}return n.attr("id")},i=function(t){try{var n=e(t)}catch(e){return null}return 0===n.length?null:n.is('input[type="checkbox"]')?!0===n.prop("checked"):n.is('input[type="radio"]')&&void 0!==n.attr("name")?e('input[name="'+n.attr("name")+'"]:checked').val():void 0!==n.prop("value")?n.val():n.html()},o=function(t,n,a){try{var i=e(t)}catch(e){return}0!==i.length&&(i.is('input[type="checkbox"]')?n?i.attr("checked",!0):i.removeAttr("checked"):void 0!==i.prop("value")?a?i.attr("value",n):i.val(n):i.html(n))},r=function(e){return void 0===e||e},l=function(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")},d=function(t,n,a,i){var o=function(t){var n=e(t);"object"==typeof t&&"attributes"in t&&e.each(t.attributes,function(t,o){"string"===e.type(o.value)&&n.attr(o.name.replace(a,i),o.value.replace(a,i))}),n.length>0&&e.each(n.data(),function(t,o){"string"===e.type(o)&&n.data(t.replace(a,i),o.replace(a,i))})},r=t.eq(n);o(r[0]),r.find("*").each(function(){o(this)})},s=function(t,n,a,i,o,r){var s=new RegExp(l(a.name_prefix+"["+o+"]"),"g"),c=a.name_prefix+"["+r+"]";a.children&&e.each(a.children,function(e,n){var a=t.find(n.selector).eq(i),o=a.data("collection-settings");o&&(o.name_prefix=o.name_prefix.replace(s,c),a.data("collection-settings",o))}),d(n,i,s,c),s=new RegExp(l(t.attr("id")+"_"+o),"g"),c=t.attr("id")+"_"+r,a.children&&e.each(a.children,function(e,n){var a=t.find(n.selector).eq(i),o=a.data("collection-settings");o&&(o.elements_parent_selector=o.elements_parent_selector.replace(s,c),o.elements_selector=o.elements_selector.replace(s,c),o.prefix=o.prefix.replace(s,c),a.data("collection-settings",o))}),d(n,i,s,c)},c=function(e,t,n,a){var i=e.data("collection-settings");return i.position_field_selector||i.preserve_names||(s(e,t,i,n,n,"__swap__"),s(e,t,i,a,a,n),s(e,t,i,n,"__swap__",a)),t.eq(n).insertBefore(t.eq(a)),a>n?t.eq(a).insertBefore(t.eq(n)):t.eq(a).insertAfter(t.eq(n)),e.find(i.elements_selector)},f=function(e,t,n,a,i){for(var o=a+1;o<=i;o++)t=c(e,t,o,o-1);return e.find(n.elements_selector)},p=function(e,t,n,a,i){for(var o=a-1;o>=i;o--)t=c(e,t,o,o+1);return e.find(n.elements_selector)},_=function(e,t,n,a){for(var i=a+1;i<t.length;i++)t=c(e,t,i-1,i);return e.find(n.elements_selector)},u=function(t,n,i,o){var r=e(n.elements_parent_selector),l=0===r.find("."+n.prefix+"-tmp").length,d=t.find(n.elements_selector);if(n.allow_add&&l&&(r.append('<span class="'+n.prefix+'-tmp"></span>'),n.add&&r.append(e(n.add).addClass(n.prefix+"-action "+n.prefix+"-rescue-add").data("collection",t.attr("id")))),i){t.data("collection-offset",d.length);for(var s=e(n.container),c=t.find("."+n.prefix+"-add, ."+n.prefix+"-rescue-add, ."+n.prefix+"-duplicate").first(),f=0;d.length<n.init_with_n_elements;){f++;var p=d.length>0?d.last():void 0,_=d.length-1;if(d=h(s,c,t,n,d,p,_,!1),f>n.init_with_n_elements){console.error("Infinite loop, element selector ("+n.elements_selector+") not found !");break}}t.data("collection-offset",d.length)}if(d.each(function(r){var l=e(this);i&&l.data("index",r);var s=l.find("."+n.prefix+"-actions").addBack().filter("."+n.prefix+"-actions");0===s.length&&(s=e("<"+n.action_container_tag+' class="'+n.prefix+'-actions"></'+n.action_container_tag+">"),l.append(s));var c=0;"remove"===o&&n.fade_out&&(c=1);var f=[{enabled:n.allow_remove,selector:n.prefix+"-remove",html:n.remove,condition:d.length-c>n.min},{enabled:n.allow_up,selector:n.prefix+"-up",html:n.up,condition:d.length-c>1&&d.index(l)-c>0},{enabled:n.allow_down,selector:n.prefix+"-down",html:n.down,condition:d.length-c>1&&d.index(l)!==d.length-1},{enabled:n.allow_add&&!n.add_at_the_end&&!n.custom_add_location,selector:n.prefix+"-add",html:n.add,condition:d.length-c<n.max},{enabled:n.allow_duplicate,selector:n.prefix+"-duplicate",html:n.duplicate,condition:d.length-c<n.max}];e.each(f,function(i,o){if(o.enabled){var d=l.find("."+o.selector);0===d.length&&o.html&&(d=e(o.html).appendTo(s).addClass(o.selector)),o.condition?(d.removeClass(n.prefix+"-action-disabled"),n.hide_useless_buttons&&d.css("display","")):(d.addClass(n.prefix+"-action-disabled"),n.hide_useless_buttons&&d.css("display","none")),d.addClass(n.prefix+"-action").data("collection",t.attr("id")).data("element",a(t.attr("id")+"_"+r,l))}else l.find("."+o.selector).css("display","none")})}),n.allow_add){var u=0;"remove"===o&&n.fade_out&&(u=1);var m=t.find("."+n.prefix+"-rescue-add").css("display","").removeClass(n.prefix+"-action-disabled"),v=t.find("."+n.prefix+"-add");!n.add_at_the_end&&v.length>u||n.custom_add_location?m.css("display","none"):"remove"===o&&n.fade_out&&(m.css("display","1"),m.fadeIn("fast")),d.length-u>=n.max&&(m.addClass(n.prefix+"-action-disabled"),n.hide_useless_buttons&&t.find("."+n.prefix+"-add, ."+n.prefix+"-rescue-add, ."+n.prefix+"-duplicate").css("display","none"))}},m=function(t,n,a){a.children&&e.each(a.children,function(e,a){if(!a.selector)return console.log("jquery.collection.js: given collection "+t.attr("id")+" has children collections, but children's root selector is undefined."),!0;null!==n?n.find(a.selector).collection(a):t.find(a.selector).collection(a)})},h=function(t,n,a,d,s,c,f,p){if(s.length<d.max&&(p&&r(d.before_duplicate(a,c))||r(d.before_add(a,c)))){var h=a.data("prototype"),v=a.data("collection-offset");a.data("collection-offset",v+1),-1===f&&(f=s.length-1);var j=new RegExp(l(d.prototype_name),"g"),q=v;d.preserve_names&&(void 0===(q=a.data("collection-free-key"))&&(q=b(d,s)),a.data("collection-free-key",q+1));var C=e(h.replace(j,q)).data("index",v);y(d,C);var k=e(d.elements_parent_selector).find("> ."+d.prefix+"-tmp");e(C).find("[id]").first().attr("id");if(p){var A=s.eq(f);e(A).find(":input").each(function(e,t){o(t,i(t),!0)});var E=e("<div/>").append(A.clone()).html(),Q=d.preserve_names||d.position_field_selector?A.data("index"):f,R=d.preserve_names?w(d,A):Q,B=(I=a,M=d,$=E,F=Q,T=v,N=R,O=q,V=new RegExp(l(M.name_prefix+"["+N+"]"),"g"),z=M.name_prefix+"["+O+"]",$=$.replace(V,z),V=new RegExp(l(I.attr("id")+"_"+F),"g"),z=I.attr("id")+"_"+T,$=$.replace(V,z));C=e("<div/>").html(B).contents().data("index",v),d.fade_in&&C.hide(),k.before(C).find(d.prefix+"-actions").remove()}else d.fade_in&&C.hide(),k.before(C);s=a.find(d.elements_selector);var D=C.find("."+d.prefix+"-add, ."+d.prefix+"-duplicate");D.length>0&&D.addClass(d.prefix+"-action").data("collection",a.attr("id")),d.add_at_the_end||f+1===v?u(a,d,!1):s=g(a,d,s,C,v,f+1),m(a,C,d),(p&&!r(d.after_duplicate(a,C))||!r(d.after_add(a,C)))&&(-1!==f&&(s=_(a,s,d,f+1)),C.remove())}var I,M,$,F,T,N,O,V,z;if(void 0!==C&&d.fade_in)C.fadeIn("fast",function(){d.position_field_selector&&x(d,s)});else if(d.position_field_selector)return x(d,s);return s},v=function(t,n,a,i,o){if(a.length>n.min&&r(n.before_remove(t,i))){var l=function(){var l=i;n.preserve_names||(l=(a=_(t,a,n,o)).last());var d=l.clone({withDataAndEvents:!0}).show();(l.remove(),r(n.after_remove(t,d)))||(e(n.elements_parent_selector).find("> ."+n.prefix+"-tmp").before(d),a=t.find(n.elements_selector),a=function(e,t,n,a){for(var i=t.length-2;i>a;i--)t=c(e,t,i+1,i);return e.find(n.elements_selector)}(t,a,n,o-1));n.position_field_selector&&x(n,a)};alertify.confirm(e(i)[0].hasAttribute("data-title")?e(i).data("title"):n.delete_title,e(i)[0].hasAttribute("data-msg")?e(i).data("msg"):n.delete_msg,function(){n.fade_out?i.fadeOut("fast",function(){l()}):l()},function(){a.find("."+n.prefix+"-remove").each(function(){e(this).removeClass(n.prefix+"-action-disabled"),e(this).css("display","")})})}return a},g=function(e,t,n,a,i,o){return 1===Math.abs(o-i)?(n=c(e,n,i,o),r(o-i>0?t.after_up(e,a):t.after_down(e,a))||(n=c(e,n,o,i))):i<o?(n=f(e,n,t,i,o),r(o-i>0?t.after_up(e,a):t.after_down(e,a))||(n=p(e,n,t,o,i))):(n=p(e,n,t,i,o),r(o-i>0?t.after_up(e,a):t.after_down(e,a))||(n=f(e,n,t,o,i))),u(e,t,!1),t.position_field_selector?x(t,n):n},x=function(t,n){return e(n).each(function(){var a=e(this);o(a.find(t.position_field_selector),n.index(a))}),n},w=function(e,t){return t.find(':input[name^="'+e.name_prefix+'["]').attr("name").slice(e.name_prefix.length+1).split("]",1)[0]},b=function(t,n){var a=0;return n.each(function(){var n=w(t,e(this));/^0|[1-9]\d*$/.test(n)&&n>=a&&(a=Number(n)+1)}),a},y=function(t,n){e.each(["-action","-action-disabled","-actions","-add","-down","-duplicate","-remove","-rescue-add","-tmp","-up"],function(){var a=this;n.each(function(){var n=e(this);n.hasClass(t.user_prefix+a)&&n.addClass(t.prefix+a),n.find("*").each(function(){var n=e(this);n.hasClass(t.user_prefix+a)&&n.addClass(t.prefix+a)})})})},j=e(this);return 0===j.length?(console.log("jquery.collection.js: given collection selector does not exist."),!1):(j.each(function(){var l=e.extend(!0,{},n,t);if(0===e(l.container).length)return console.log("jquery.collection.js: a container should exist to handle events (basically, a <body> tag)."),!1;var d,s,f=e(this);if(void 0!==f.data("collection")){var p=e("#"+f.data("collection"));if(0===p.length)return console.log("jquery.collection.js: given collection id does not exist."),!0}else p=f;if(p=e(p),l.elements_parent_selector=l.elements_parent_selector.replace("%id%","#"+a("",p)),!l.elements_parent_selector&&(l.elements_parent_selector="#"+a("",p),0===e(l.elements_parent_selector).length))return console.log("jquery.collection.js: given elements parent selector does not return any object."),!0;if(l.user_prefix=l.prefix,l.prefix=p.attr("id")+"-"+l.user_prefix,y(l,p),l.allow_add||(l.allow_duplicate=!1,l.add_at_the_end=!1),l.init_with_n_elements>l.max&&(l.init_with_n_elements=l.max),l.min&&(!l.init_with_n_elements||l.init_with_n_elements<l.min)&&(l.init_with_n_elements=l.min),!l.action_container_tag)return console.log("jquery.collection.js: action_container_tag needs to be set."),!0;if(l.before_init(p),null===p.data("prototype"))return console.log("jquery.collection.js: given collection field has no prototype, check that your field has the prototype option set to true."),!0;if(void 0!==p.data("prototype-name")&&(l.prototype_name=p.data("prototype-name")),void 0!==p.data("allow-add")&&(l.allow_add=p.data("allow-add"),l.allow_duplicate=!!p.data("allow-add")&&l.allow_duplicate),void 0!==p.data("allow-remove")&&(l.allow_remove=p.data("allow-remove")),void 0!==p.data("name-prefix")&&(l.name_prefix=p.data("name-prefix")),void 0!==p.data("allow-min")&&(l.min=p.data("allow-min")),void 0!==p.data("allow-max")&&(l.max=p.data("allow-max")),!l.name_prefix)return console.log("jquery.collection.js: the prefix used in descendant field names is mandatory, you can set it using 2 ways:"),console.log("jquery.collection.js: - use the form theme given with this plugin source"),console.log("jquery.collection.js: - set name_prefix option to  '{{ formView.myCollectionField.vars.full_name }}'"),!0;(l.preserve_names&&(l.allow_up=!1,l.allow_down=!1,l.drag_drop=!1,l.add_at_the_end=!0),void 0!==jQuery.ui&&void 0!==jQuery.ui.sortable&&p.data("sortable")&&p.sortable("disable"),l.drag_drop&&l.allow_up&&l.allow_down)&&(void 0===jQuery.ui||void 0===jQuery.ui.sortable?l.drag_drop=!1:p.sortable(e.extend(!0,{},{start:function(t,n){var a=p.find(l.elements_selector),i=n.item,o=e(this);r(l.drag_drop_start(t,n,a,i))?(n.placeholder.height(n.item.height()),n.placeholder.width(n.item.width()),d=a.index(i)):o.sortable("cancel")},update:function(t,n){var a=p.find(l.elements_selector),i=n.item;e(this).sortable("cancel"),!1!==l.drag_drop_update(t,n,a,i)&&r(s-d>0?l.before_up(p,i):l.before_down(p,i))&&(s=a.index(i),a=p.find(l.elements_selector),g(p,l,a,i,d,s))}},l.drag_drop_options)));p.data("collection-settings",l);var _=e(l.container);if(_.off("click","."+l.prefix+"-action").on("click","."+l.prefix+"-action",function(t){var n,a,i=e(this);if(void 0===(a=(n=e("#"+i.data("collection"))).data("collection-settings"))&&void 0===(a=(n=e("#"+i.data("collection")).find("."+i.data("collection")+"-collection")).data("collection-settings")))throw"Can't find collection: "+i.data("collection");var o,l,d,s,f,p,m,g,w,b,y=n.find(a.elements_selector),j=i.data("element")?e("#"+i.data("element")):void 0,q=j&&j.length?y.index(j):-1,C=null,k=i.is("."+a.prefix+"-duplicate");(i.is("."+a.prefix+"-add")||i.is("."+a.prefix+"-rescue-add")||k)&&a.allow_add&&(C="add",y=h(_,i,n,a,y,j,q,k)),i.is("."+a.prefix+"-remove")&&a.allow_remove&&(C="remove",y=v(n,a,y,j,q)),i.is("."+a.prefix+"-up")&&a.allow_up&&(C="up",o=n,l=a,d=y,s=j,0!==(f=q)&&r(l.before_up(o,s))&&(d=c(o,d,f,f-1),r(l.after_up(o,s))||(d=c(o,d,f-1,f))),y=l.position_field_selector?x(l,d):d),i.is("."+a.prefix+"-down")&&a.allow_down&&(C="down",p=n,m=a,w=j,(b=q)!==(g=y).length-1&&r(m.before_down(p,w))&&(g=c(p,g,b,b+1),r(m.after_down(p,g))||(g=c(p,g,b+1,b))),y=m.position_field_selector?x(m,g):g),u(n,a,!1,C),t.preventDefault()}),u(p,l,!0),m(p,null,l),l.position_field_selector){var w=[],b=p.find(l.elements_selector);b.each(function(t){var n=e(this);w.push({position:parseFloat(i(n.find(l.position_field_selector))),element:n})});w.sort(function(e,t){return e.position<t.position?-1:e.position>t.position?1:0}),e.each(w,function(t,n){var a=[];e(b).each(function(t){a.push(e(this).attr("id"))});var i=n.element,r=e.inArray(i.attr("id"),a);t!==r&&(b=g(p,l,b,i,r,t),o(i.find(l.position_field_selector),b.index(i)))})}l.after_init(p)}),!0)}}(jQuery);
